#!/usr/bin/env bash

set -euo pipefail 

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m'

show_help() {
	echo ""
	cat << EOF
Usage: $(basename "$0") [OPTIONS]

RHEL System Analysis Tool - Module 1: Core System Reconnaissance

OPTIONS:
	-h, --help		Show this help message
	-i, --info		Display system information
	-c, --check		Run system checks
	-u, --users 	List regular users
	-s, --services	Check service status
	-l, --logs		Analyze system logs

EXAMPLES:
	$(basename "$0") --info
	$(basename "$0") --check
EOF
echo ""
}

show_system_info() {
	echo -e "\n${GREEN}=== System Information ===${NC}\n"

	if [[ -f /etc/os-release ]]; then
		source /etc/os-release
		echo -e "OS Name:		${NAME}"
		echo -e "Version:		${VERSION}"
		echo -e "ID:			${ID}"
	fi

	echo -e "Kernel:			$(uname -r)"
	echo -e "Hostname:		$(hostname)"
	echo -e "Uptime:			$(uptime -p)"
	echo ""
}

run_system_checks() {
	echo ""
	echo -e "${GREEN}=== System Checks ===${NC}"
	local checks_failed=0

	if getent passwd rhel_student | grep -q ':2000'; then
		echo -e "${GREEN}[✔]${NC} User 'rhel_student' exists with UID 2000"
	else
		echo -e "${RED}[✗]${NC} User 'rhel_student' not found or incorrect UID"
		((checks_failed++))
	fi

	if [[ -f /opt/navigator-secrets/config ]]; then
		permissions=$(stat -c '%a' /opt/navigator-secrets/config)
		if [[ "$permissions" == "600" ]]; then
			echo -e "${GREEN}[✔]${NC} Secret file has correct permissions (600)"
		else
			echo -e "${YELLOW}[!]${NC} Secret file permissions: $permissions (expected: 600)"
			((checks_failed++)) || true
		fi
	else
		echo -e "${RED}[✗]${NC} Secret file not found"
		((checks_failed++))
	fi

	if [[ -f /etc/shadow ]]; then
		shadow_permissions=$(stat -c '%a' /etc/shadow)
		shadow_permissions=$(printf "%03d" "$shadow_permissions")
		if [[ "$shadow_permissions" == "000" ]] || [[ "$shadow_permissions" == "400" ]]; then
			echo -e "${GREEN}[✓]${NC} /etc/shadow has secure permissions ($shadow_permissions)"
		else
			echo -e "${RED}[✗]${NC} /etc/shadow permissions: $shadow_permissions (should be 000 or 400)"
			((checks_failed++))
		fi
	fi

	if [[ $checks_failed -eq 0 ]]; then
		echo -e "${GREEN}[✓]All checks are passed${NC}"
	else
		echo -e "${RED}[✗]Failed checks: $checks_failed"
	fi

	echo ""

	return $checks_failed
		
}

list_users() {
	echo -e "${GREEN}=== Regular Users (UID >= 1000) ===${NC}"

	while IFS=: read -r username _ uid gid _ homedir shell; do
		if [[ $uid -ge 1000 ]] && [[ $uid -ne 65534 ]]; then
			echo -e "User: ${YELLOW}$username${NC} | UID: $uid | Home: $homedir | Shell: $shell"
		fi
	done < /etc/passwd
}

check_services() {
	echo -e "\n${GREEN}=== Service Status ===${NC}\n"
	local services=("httpd" "sshd")

	for service in "${services[@]}"; do
		if command -v systemctl &>/dev/null; then
			if systemctl is-active --quiet "$service"; then
				echo -e "${GREEN}[✓]${NC} $service is active"
			else
				echo -e "${RED}[✗]${NC} $service is not running"
			fi
		fi
	done
	echo ""
}

check_logs() {
	echo -e "\n${GREEN}=== Log Analysis ===${NC}\n"

	local last_entry=$(sudo journalctl -t navigator-test --no-pager -n 1 | tail -1)
	if [[ -z $last_entry ]]; then
		echo -e "${RED}[✗]${NC} Test log entry not found"
	else
		echo -e "${GREEN}[✓]${NC} Found the following test log entry: \n\n${YELLOW}$last_entry${NC}"	
	fi

	local error_count=$(sudo journalctl -p err --since "1 hour ago" --no-pager | grep -c "^")
	echo -e "\n${YELLOW}[i]${NC} Errors in last hour: $error_count"
	echo ""

}

main() {
	
	if [[ $# -eq 0 ]]; then
		show_help
		exit 0
	fi

	case "$1" in
		-h|--help)
			show_help
			;;
		-i|--info)
			show_system_info
			;;
		-c|--check)
			run_system_checks
			;;
		-u|--users)
			list_users
			;;
		-s|--services)
			check_services
			;;
		-l|--logs)
			check_logs
			;;
		*)
			echo "Unknown option: $1"
			show_help
			exit 1
			;;
	esac
}

main "$@"