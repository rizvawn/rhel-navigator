#!/usr/bin/env bash

set -euo pipefail 

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m'

show_help() {
	echo ""
	cat << EOF
Usage: $(basename "$0") [OPTIONS]

RHEL System Analysis Tool - Modules 1 & 2

OPTIONS:
	-h, --help			Show this help message
	-i, --info			Display system information
	-c, --check			Run system checks
	-u, --users 		List regular users
	-s, --services		Check service status
	-l, --logs			Analyze system logs
	-d, --disk			Check storage and updates
	-n, --network		Check network listeners
	-p, --containers	Check container runtime
	-b, --backup		Create backup archive
	-k, --ssh			Check SSH key configuration

EXAMPLES:
	$(basename "$0") --info
	$(basename "$0") --check
EOF
echo ""
}

show_system_info() {
	echo -e "\n${GREEN}=== System Information ===${NC}\n"

	if [[ -f /etc/os-release ]]; then
		source /etc/os-release
		echo -e "OS Name:		${NAME}"
		echo -e "Version:		${VERSION}"
		echo -e "ID:			${ID}"
	fi

	echo -e "Kernel:			$(uname -r)"
	echo -e "Hostname:		$(hostname)"
	echo -e "Uptime:			$(uptime -p)"
	echo ""
}

run_system_checks() {
	echo ""

	echo -e "${GREEN}=== Module 1: Core System Checks ===${NC}"
	echo -e "${YELLOW}(User accounts and file permissions)${NC}\n"

	local checks_failed=0

	if getent passwd rhel_student | grep -q ':2000'; then
		echo -e "${GREEN}[✔]${NC} User 'rhel_student' exists with UID 2000"
	else
		echo -e "${RED}[✗]${NC} User 'rhel_student' not found or incorrect UID"
		((checks_failed++)) || true
	fi

	if [[ -f /opt/navigator-secrets/config ]]; then
		permissions=$(stat -c '%a' /opt/navigator-secrets/config)
		if [[ "$permissions" == "600" ]]; then
			echo -e "${GREEN}[✔]${NC} Secret file has correct permissions (600)"
		else
			echo -e "${YELLOW}[!]${NC} Secret file permissions: $permissions (expected: 600)"
			((checks_failed++)) || true
		fi
	else
		echo -e "${RED}[✗]${NC} Secret file not found"
		((checks_failed++)) || true
	fi

	if [[ -f /etc/shadow ]]; then
		shadow_permissions=$(stat -c '%a' /etc/shadow)
		shadow_permissions=$(printf "%03d" "$shadow_permissions")
		if [[ "$shadow_permissions" == "000" ]] || [[ "$shadow_permissions" == "400" ]]; then
			echo -e "${GREEN}[✓]${NC} /etc/shadow has secure permissions ($shadow_permissions)"
		else
			echo -e "${RED}[✗]${NC} /etc/shadow permissions: $shadow_permissions (should be 000 or 400)"
			((checks_failed++)) || true
		fi
	fi

	echo -e "\n${GREEN}=== Module 2: System Administration Checks ===${NC}"
	echo -e "${YELLOW}(Services, logs and storage)${NC}\n"

	if systemctl is-active --quiet httpd; then
		echo -e "${GREEN}[✔]${NC} httpd service is running"
	else
		echo -e "${RED}[✗]${NC} httpd service is not active"
		((checks_failed++)) || true
	fi

	local log_entry=$(sudo journalctl -t navigator-test --no-pager -n 1 2>/dev/null)
	if [[ -n $log_entry ]]; then
		echo -e "${GREEN}[✔]${NC} The following test log entry found:\n$log_entry"
	else
		echo -e "${RED}[✗]${NC} Test log entry not found"
	fi

	echo -e "\n${GREEN}=== Module 3: Networking &  Containers ===${NC}"
	echo -e "${YELLOW}(Network services and container runtime)${NC}\n"

	if ss -tuln | grep -q ":8080"; then
		echo -e "${GREEN}[✓]${NC} Port 8080 is listening (container port)"
	else
		echo -e "${RED}[✗]${NC} Port 8080 not listening"
		((checks_failed++)) || true
	fi

	if command -v podman &>/dev/null; then
		local container_count=$(podman ps --format "{{.Names}}" 2>/dev/null | wc -l)
		if [[ $container_count -gt 0 ]]; then
			echo -e "${GREEN}[✓]${NC} Podman containers running: $container_count"
		else
			echo -e "${YELLOW}[!]${NC} No containers running"
		fi
	else
		echo -e "${RED}[✗]${NC} Podman not available"
		((checks_failed++)) || true
	fi

	if [[ $checks_failed -eq 0 ]]; then
		echo -e "\n${GREEN}[✓]All checks are passed${NC}"
	else
		echo -e "\n${RED}[✗]Failed checks: $checks_failed"
	fi

	echo ""		
}

list_users() {
	echo -e "${GREEN}=== Regular Users (UID >= 1000) ===${NC}"

	while IFS=: read -r username _ uid gid _ homedir shell; do
		if [[ $uid -ge 1000 ]] && [[ $uid -ne 65534 ]]; then
			echo -e "User: ${YELLOW}$username${NC} | UID: $uid | Home: $homedir | Shell: $shell"
		fi
	done < /etc/passwd
}

check_services() {
	echo -e "\n${GREEN}=== Service Status ===${NC}\n"
	local services=("httpd" "sshd")

	for service in "${services[@]}"; do
		if command -v systemctl &>/dev/null; then
			if systemctl is-active --quiet "$service"; then
				echo -e "${GREEN}[✓]${NC} $service is active"
			else
				echo -e "${RED}[✗]${NC} $service is not running"
			fi
		fi
	done
	echo ""
}

check_logs() {
	echo -e "\n${GREEN}=== Log Analysis ===${NC}\n"

	local last_entry=$(sudo journalctl -t navigator-test --no-pager -n 1 | tail -1)
	if [[ -z $last_entry ]]; then
		echo -e "${RED}[✗]${NC} Test log entry not found"
	else
		echo -e "${GREEN}[✓]${NC} Found the following test log entry: \n\n${YELLOW}$last_entry${NC}"	
	fi

	local error_count=$(sudo journalctl -p err --since "1 hour ago" --no-pager | grep -c "^")
	echo -e "\n${YELLOW}[i]${NC} Errors in last hour: $error_count"
	echo ""

}

check_storage() {
	echo -e "\n${GREEN}=== Storage & Updates ===${NC}\n"
	
	local usage=$(df -h / | awk 'NR==2 {print $5}' | tr -d '%')
	local used=$(df -h / | awk 'NR==2 {print $3}')
	local total=$(df -h / | awk 'NR==2 {print $2}')

	if [[ $usage -lt 80 ]]; then
		echo -e "${GREEN}[✓]${NC} Root partition: $used / $total ($usage% used)"
	else
		echo -e "${YELLOW}[!]${NC} Root partition: $used / $total ($usage% used - over 80%)"
	fi

	echo ""

	local update_count=$(sudo dnf check-update 2>/dev/null | grep -v "^$" | grep -v "Last metadata" | grep -E "^\S+\s+\S+\s+\S+" | wc -l)
	echo -e "${YELLOW}[i]${NC} Available updates: $update_count packages"
	echo  ""
}

check_network() {
	echo -e "\n${GREEN}=== Network Listeners ===${NC}\n"

	if command -v ss &>/dev/null; then
		local listen_count=$(ss -tuln | grep LISTEN | wc -l)
		echo -e "${YELLOW}[i]${NC} Total listening ports: $listen_count"

		if ss -tuln | grep -q ":8080"; then
			local container=$(podman ps --format "{{.Names}}")
			echo -e "${GREEN}[✓]${NC} Port 8080 is listening to $container container"
		else
			echo -e "${RED}[✗]${NC} Port 8080 not listening"
		fi
	fi
	echo ""
}

check_containers() {
	echo -e "\n${GREEN}=== Container Runtime ===${NC}\n"

	if command -v podman &>/dev/null; then
		if command -v python3 &>/dev/null; then
			podman ps --format json | python3 "${PROJECT_ROOT}/lib/container_parser.py"
		else
			local count=$(podman ps --format "{{.Names}}" | wc -l)
			echo -e "${YELLOW}[i]${NC} Running containers: $count"
			podman ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
		fi
	else
		echo -e "${RED}[✗]${NC} Podman not installed"
	fi
	echo ""
}

create_backup() {
	echo -e "\n${GREEN}=== Backup Archive ===${NC}\n"

	local backup_dir="${PROJECT_ROOT}/var/cache"
	local timestamp=$(date +%Y%m%d_%H%M%S)
	local archive_name="navigator_backup_${timestamp}.tar.gz"
	local archive_path="${backup_dir}/${archive_name}"

	local items_to_backup=(
		"${PROJECT_ROOT}/bin"
		"${PROJECT_ROOT}/lib"
		"${PROJECT_ROOT}/etc"
	)

	echo -e "${YELLOW}[i]${NC} Creating backup archive..."
	tar -czf "$archive_path" -C "$PROJECT_ROOT" bin lib etc 2>/dev/null

	if [[ -f "$archive_path" ]]; then
		local size=$(du -h "$archive_path" | awk '{print $1}')
		echo -e "${GREEN}[✓]${NC} Backup created: $archive_name ($size)"
		echo -e "    Location: $archive_path"

		local backup_count=$(find "$backup_dir" -name "navigator_backup_*.tar.gz" | wc -l)
		echo -e "${YELLOW}[i]${NC} Total backups: $backup_count"
	else
		echo -e "${RED}[✗]${NC} Backup creation failed"
	fi
	echo ""
}

check_ssh_keys() {
	echo -e "\n${GREEN}=== SSH Key Audit ===${NC}\n"

	local ssh_dir="$HOME/.ssh"
	local test_key="${ssh_dir}/navigator_key"

	if [[ -f "$test_key" ]]; then
		local key_permissions=$(stat -c '%a' "$test_key")
		if [[ "$key_permissions" == "600" ]]; then
			echo -e "${GREEN}[✓]${NC} SSH private key has secure permissions (600)"
		else
			echo -e "${RED}[✗]${NC} SSH private key permissions: $key_permissions (should be 600)"
		fi

		if [[ -f "${test_key}.pub" ]]; then
			echo -e "${GREEN}[✓]${NC} SSH public key exists"
			local key_type=$(ssh-keygen -l -f "${test_key}.pub" | awk '{print $NF}')
			echo -e "${YELLOW}[i]${NC} Key type: $key_type"
		fi
	else
		echo -e "${RED}[✗]${NC} SSH key not found at $test_key"
	fi
	echo ""
}

main() {
	
	if [[ $# -eq 0 ]]; then
		show_help
		exit 0
	fi

	case "$1" in
		-h|--help)
			show_help
			;;
		-i|--info)
			show_system_info
			;;
		-c|--check)
			run_system_checks
			;;
		-u|--users)
			list_users
			;;
		-s|--services)
			check_services
			;;
		-l|--logs)
			check_logs
			;;
		-d|--disk)
			check_storage
			;;
		-n|--network)
			check_network
			;;
		-p|--containers)
			check_containers
			;;
		-b|--backup)
			create_backup
			;;
		-k|--ssh)
			check_ssh_keys
			;;
		*)
			echo "Unknown option: $1"
			show_help
			exit 1
			;;
	esac
}

main "$@"